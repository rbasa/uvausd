name: Daily ETL Update

on:
  schedule:
    # Run daily at 2 AM UTC (23:00 Argentina del d√≠a anterior)
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to update (default: 7)'
        required: false
        default: '7'

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Dolt
        run: |
          sudo bash -c 'curl -L https://github.com/dolthub/dolt/releases/latest/download/install.sh | bash'
          sudo cp /usr/local/bin/dolt /usr/bin/dolt

      - name: Configure Dolt credentials
        env:
          DOLT_CREDS_PRIVATE_KEY: ${{ secrets.DOLT_CREDS_PRIVATE_KEY }}
        run: |
          set -e
          echo "üîê Configuring Dolt credentials..."
          
          # Validate secret is not empty
          if [ -z "$DOLT_CREDS_PRIVATE_KEY" ]; then
            echo "‚ùå DOLT_CREDS_PRIVATE_KEY secret is empty or not set"
            echo "   Please add the JWK content to GitHub Secrets ‚Üí DOLT_CREDS_PRIVATE_KEY"
            exit 1
          fi
          
          # Validate JWK format
          echo "   Validating JWK format..."
          if ! echo "$DOLT_CREDS_PRIVATE_KEY" | python3 -c "import json, sys; json.load(sys.stdin)" 2>/dev/null; then
            echo "‚ùå Invalid JSON in DOLT_CREDS_PRIVATE_KEY"
            echo "   First 100 chars: $(echo "$DOLT_CREDS_PRIVATE_KEY" | head -c 100)..."
            exit 1
          fi
          
          # Check JWK has required fields
          if ! echo "$DOLT_CREDS_PRIVATE_KEY" | python3 -c "import json, sys; jwk=json.load(sys.stdin); sys.exit(0 if 'kty' in jwk and 'x' in jwk else 1)" 2>/dev/null; then
            echo "‚ùå JWK missing required fields (needs 'kty' and 'x')"
            exit 1
          fi
          echo "   ‚úÖ JWK format is valid"
          
          # Configure Dolt user
          dolt config --global --add user.name "GitHub Actions"
          dolt config --global --add user.email "actions@github.com"
      
          # Set up credentials directory
          mkdir -p ~/.dolt/creds
          CRED_FILE="$HOME/.dolt/creds/gha-creds.jwk"
      
          # Save JWK to file
          echo "$DOLT_CREDS_PRIVATE_KEY" > "$CRED_FILE"
          chmod 600 "$CRED_FILE"
          echo "   ‚úÖ JWK saved to $CRED_FILE"
      
          # Import credential and capture the ID that dolt returns
          echo "   Importing credential..."
          IMPORT_OUTPUT=$(dolt creds import "$CRED_FILE" 2>&1)
          echo "$IMPORT_OUTPUT"
      
          # Extract credential ID from import output
          CRED_ID=$(echo "$IMPORT_OUTPUT" | grep -i "credential id" | awk '{print $NF}' | head -n 1)
      
          if [ -z "$CRED_ID" ]; then
            echo "‚ùå Could not extract CRED_ID from 'dolt creds import'"
            echo "   Import output: $IMPORT_OUTPUT"
            exit 1
          fi
      
          # Use the credential
          dolt creds use "$CRED_ID" || {
            echo "‚ö†Ô∏è  'dolt creds use' failed, but credential may still work"
          }
      
          echo "‚úÖ Credentials configured (ID: $CRED_ID)"
          echo "   Available credentials:"
          dolt creds ls || echo "   (dolt creds ls not available)"

      - name: Test Dolt credentials
        run: |
          set -e
          echo "üß™ Testing Dolt credentials..."
          echo ""
          
          # Test 1: Verify credentials are configured
          echo "1Ô∏è‚É£  Checking configured credentials..."
          if ! dolt creds ls | grep -q .; then
            echo "‚ùå No credentials found"
            exit 1
          fi
          echo "   ‚úÖ Credentials found"
          echo ""
          
          # Test 2: Try to clone (this will test authentication)
          echo "2Ô∏è‚É£  Testing authentication by cloning repository..."
          TEST_DIR="test_dolt_auth_$$"
          if dolt clone rbasa/macroeconomia "$TEST_DIR" 2>&1; then
            echo "   ‚úÖ Authentication successful!"
            rm -rf "$TEST_DIR"
          else
            CLONE_ERROR=$?
            echo "   ‚ùå Authentication failed (exit code: $CLONE_ERROR)"
            echo ""
            echo "   Debugging info:"
            echo "   - Available credentials:"
            dolt creds ls || echo "     (none)"
            echo "   - Credential files:"
            ls -la ~/.dolt/creds/ 2>&1 || echo "     (none)"
            echo ""
            echo "   Please verify:"
            echo "   1. The JWK in GitHub Secret 'DOLT_CREDS_PRIVATE_KEY' is correct"
            echo "   2. The public key is added to DoltHub: https://www.dolthub.com/settings/credentials"
            echo "   3. The credential has write permissions for rbasa/macroeconomia"
            exit 1
          fi
          echo ""
          echo "‚úÖ All credential tests passed!"

      - name: Clone or update Dolt database
        run: |
          # Clone the database if it doesn't exist
          if [ ! -d "macroeconomia" ]; then
            dolt clone rbasa/macroeconomia macroeconomia
          else
            cd macroeconomia
            dolt pull
            cd ..
          fi

      - name: Start Dolt SQL Server and run ETL
        env:
          DOLT_DB: "mysql://user:@localhost:3306/macroeconomia"
          UPDATE_DAYS: ${{ github.event.inputs.days_back || '7' }}
        run: |
          set -euo pipefail

          cd macroeconomia

          # Start server in background and save PID
          nohup dolt sql-server > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/dolt_server.pid

          # Wait for server to accept connections (max ~30s)
          echo "Waiting for dolt sql-server to become ready..."
          for i in {1..30}; do
            if dolt sql -q "SELECT 1" >/dev/null 2>&1; then
              echo "Server ready!"
              break
            fi
            echo "  waiting... ($i/30)"
            sleep 1
          done

          # Create user & grants (ignore errors if already present)
          dolt sql -q "CREATE USER IF NOT EXISTS 'user'@'localhost' IDENTIFIED BY ''" || true
          dolt sql -q "GRANT ALL PRIVILEGES ON *.* TO 'user'@'localhost'" || true
          dolt sql -q "FLUSH PRIVILEGES" || true

          cd ..

          echo "Running Python ETL with DOLT_DB=$DOLT_DB, UPDATE_DAYS=$UPDATE_DAYS"
          python etl/daily_update.py

          # Commit changes if any
          cd macroeconomia
          echo "Checking for changes..."
          dolt status
          echo ""
          echo "Checking diff..."
          DIFF_OUTPUT=$(dolt diff --stat 2>&1 || true)
          echo "$DIFF_OUTPUT"
          
          if echo "$DIFF_OUTPUT" | grep -q "Diff\|Rows\|Changes"; then
            echo "‚úÖ Changes detected, committing..."
            dolt add -A
            dolt commit -m "Daily ETL update $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo "‚úÖ Committed successfully"
            echo ""
            echo "Pushing to DoltHub..."
            echo "   Checking remote configuration..."
            dolt remote -v
            echo ""
            echo "   Attempting push..."
            PUSH_OUTPUT=$(dolt push origin main 2>&1)
            PUSH_EXIT=$?
            
            if [ $PUSH_EXIT -eq 0 ]; then
              echo "‚úÖ Successfully pushed to DoltHub"
            else
              echo "$PUSH_OUTPUT"
              echo ""
              # Check if error is "already up to date" (this is OK)
              if echo "$PUSH_OUTPUT" | grep -qi "up to date\|already.*up.*to.*date\|nothing to push"; then
                echo "‚ÑπÔ∏è  Remote is already up to date (this is OK)"
              # Check if error is authentication-related (this is a problem)
              elif echo "$PUSH_OUTPUT" | grep -qi "authentication\|unauthorized\|credential\|permission denied"; then
                echo "‚ùå Authentication error - credentials may not be configured correctly"
                echo ""
                echo "   Debugging info:"
                echo "   Available credentials:"
                dolt creds ls 2>&1 || echo "   (Could not list credentials)"
                echo ""
                echo "   Credential files:"
                ls -la ~/.dolt/creds/ 2>&1 || echo "   (Could not list credential files)"
                exit 1
              else
                echo "‚ö†Ô∏è  Push failed (exit code: $PUSH_EXIT)"
                echo "   This may be a temporary network issue"
                echo "   The commit was successful, so data is safe locally"
                # Don't fail the workflow for network issues
              fi
            fi
          else
            echo "‚ÑπÔ∏è  No changes detected (data may already be up to date)"
          fi

          # Stop server
          if [ -f /tmp/dolt_server.pid ]; then
            kill "$(cat /tmp/dolt_server.pid)" || true
            rm -f /tmp/dolt_server.pid
          else
            pkill -f "dolt sql-server" || true
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Daily ETL update failed"
          echo "Check logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          