name: Daily ETL Update

on:
  schedule:
    # Run daily at 2 AM UTC (11 PM Argentina time previous day)
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to update (default: 7)'
        required: false
        default: '7'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Dolt
        run: |
          sudo bash -c 'curl -L https://github.com/dolthub/dolt/releases/latest/download/install.sh | bash'
          sudo cp /usr/local/bin/dolt /usr/bin/dolt
      
      - name: Configure Dolt
        env:
          DOLT_CREDS_PRIVATE_KEY: ${{ secrets.DOLT_CREDS_PRIVATE_KEY }}
        run: |
          # Configure Dolt user
          dolt config --global --add user.name "GitHub Actions"
          dolt config --global --add user.email "actions@github.com"
          
          # Set up Dolt credentials directory
          mkdir -p ~/.dolt/creds
          
          # Get credential ID from private key filename pattern
          # The private key should be a JWK file
          CRED_ID=$(echo "$DOLT_CREDS_PRIVATE_KEY" | head -c 52 | tail -c 52)
          
          # Save the private key
          echo "$DOLT_CREDS_PRIVATE_KEY" > ~/.dolt/creds/${CRED_ID}.jwk
          chmod 600 ~/.dolt/creds/${CRED_ID}.jwk
          
          echo "✅ Credentials configured"
      
      - name: Clone or update Dolt database
        run: |
          # Clone the database if it doesn't exist (using SSH)
          if [ ! -d "dolt_db" ]; then
            dolt clone rbasa/macroeconomia dolt_db
          else
            cd dolt_db
            dolt pull
            cd ..
          fi
      
      - name: Start Dolt SQL Server and run ETL
        env:
          DOLT_DB: "mysql://user:@localhost:3306/macroeconomia"
          UPDATE_DAYS: ${{ github.event.inputs.days_back || '7' }}
        run: |
          set -euo pipefail
          cd dolt_db

          # Start server detached and save PID
          nohup dolt sql-server > server.log 2>&1 & echo $! > /tmp/dolt_server.pid

          # Wait for server to accept connections
          echo "Waiting for dolt sql-server to become ready..."
          for i in $(seq 1 30); do
            if dolt sql -q "SELECT 1" >/dev/null 2>&1; then
              echo "Server ready!"
              break
            fi
            echo "  waiting... ($i/30)"
            sleep 1
          done

          # Create user & grants (ignore errors if already present)
          dolt sql -q "CREATE USER IF NOT EXISTS 'user'@'localhost' IDENTIFIED BY ''" || true
          dolt sql -q "GRANT ALL PRIVILEGES ON *.* TO 'user'@'localhost'" || true
          dolt sql -q "FLUSH PRIVILEGES" || true

          cd ..

          # Run ETL
          python etl/daily_update.py

          # Commit changes if any
          cd dolt_db
          if dolt status --porcelain | grep -q .; then
            dolt add -A
            dolt commit -m "Daily ETL update $(date -u '+%Y-%m-%d %H:%M UTC')" || true
            dolt push origin main || true
          else
            echo "No changes to commit"
          fi

          # Stop server
          if [ -f /tmp/dolt_server.pid ]; then
            kill $(cat /tmp/dolt_server.pid) || true
            rm -f /tmp/dolt_server.pid
          else
            pkill -f "dolt sql-server" || true
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Daily ETL update failed"
          echo "Check logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

