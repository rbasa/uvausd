name: Daily ETL Update

on:
  schedule:
    # Run daily at 2 AM UTC (23:00 Argentina del día anterior)
    - cron: '0 2 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to update (default: 7)'
        required: false
        default: '7'

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Dolt
        run: |
          sudo bash -c 'curl -L https://github.com/dolthub/dolt/releases/latest/download/install.sh | bash'
          sudo cp /usr/local/bin/dolt /usr/bin/dolt

      - name: Configure Dolt credentials
        env:
          DOLT_CREDS_PRIVATE_KEY: ${{ secrets.DOLT_CREDS_PRIVATE_KEY }}
        run: |
          # Configure Dolt user
          dolt config --global --add user.name "GitHub Actions"
          dolt config --global --add user.email "actions@github.com"

          # Set up Dolt credentials directory
          mkdir -p ~/.dolt/creds

          # Extract credential ID from JWK
          # Dolt credential IDs are typically derived from the public key in the JWK
          CRED_ID=$(echo "$DOLT_CREDS_PRIVATE_KEY" | python3 << 'EOF'
          import json
          import sys
          try:
              jwk = json.load(sys.stdin)
              # Dolt credential ID is typically the 'x' field (public key) from the JWK
              # It's a base32-encoded string, usually 51 characters
              if 'x' in jwk:
                  pub_key = jwk['x']
                  # Use the public key as the credential ID (first 51 chars)
                  print(pub_key[:51] if len(pub_key) >= 51 else pub_key)
              elif 'kid' in jwk:
                  # Some JWKs have a 'kid' (key ID) field
                  print(jwk['kid'])
              else:
                  # Fallback: generate a deterministic ID from the key
                  import hashlib
                  key_str = json.dumps(jwk, sort_keys=True)
                  # Use first 51 chars of hash (Dolt IDs are typically 51 base32 chars)
                  print(hashlib.sha256(key_str.encode()).hexdigest()[:51])
          except Exception as e:
              print(f"ERROR: {e}", file=sys.stderr)
              sys.exit(1)
          EOF
          )

          if [ $? -ne 0 ] || [ -z "$CRED_ID" ]; then
            echo "❌ Failed to extract credential ID from JWK"
            echo "   JWK preview: $(echo "$DOLT_CREDS_PRIVATE_KEY" | head -c 100)..."
            exit 1
          fi

          # Save the private key with the extracted ID
          echo "$DOLT_CREDS_PRIVATE_KEY" > ~/.dolt/creds/${CRED_ID}.jwk
          chmod 600 ~/.dolt/creds/${CRED_ID}.jwk
          
          echo "✅ Credentials configured"
          echo "   Credential ID: ${CRED_ID:0:20}... (truncated for security)"
          echo "   File: ~/.dolt/creds/${CRED_ID}.jwk"
          
          # Verify the credential file exists and is readable
          if [ ! -f ~/.dolt/creds/${CRED_ID}.jwk ]; then
            echo "❌ Credential file was not created correctly"
            exit 1
          fi
          
          # List available credentials (for debugging)
          echo "   Available credentials:"
          dolt creds ls 2>&1 || echo "   (dolt creds ls not available, but file is saved)"

      - name: Clone or update Dolt database
        run: |
          # Clone the database if it doesn't exist
          if [ ! -d "macroeconomia" ]; then
            dolt clone rbasa/macroeconomia macroeconomia
          else
            cd macroeconomia
            dolt pull
            cd ..
          fi

      - name: Start Dolt SQL Server and run ETL
        env:
          DOLT_DB: "mysql://user:@localhost:3306/macroeconomia"
          UPDATE_DAYS: ${{ github.event.inputs.days_back || '7' }}
        run: |
          set -euo pipefail

          cd macroeconomia

          # Start server in background and save PID
          nohup dolt sql-server > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > /tmp/dolt_server.pid

          # Wait for server to accept connections (max ~30s)
          echo "Waiting for dolt sql-server to become ready..."
          for i in {1..30}; do
            if dolt sql -q "SELECT 1" >/dev/null 2>&1; then
              echo "Server ready!"
              break
            fi
            echo "  waiting... ($i/30)"
            sleep 1
          done

          # Create user & grants (ignore errors if already present)
          dolt sql -q "CREATE USER IF NOT EXISTS 'user'@'localhost' IDENTIFIED BY ''" || true
          dolt sql -q "GRANT ALL PRIVILEGES ON *.* TO 'user'@'localhost'" || true
          dolt sql -q "FLUSH PRIVILEGES" || true

          cd ..

          echo "Running Python ETL with DOLT_DB=$DOLT_DB, UPDATE_DAYS=$UPDATE_DAYS"
          python etl/daily_update.py

          # Commit changes if any
          cd macroeconomia
          echo "Checking for changes..."
          dolt status
          echo ""
          echo "Checking diff..."
          DIFF_OUTPUT=$(dolt diff --stat 2>&1 || true)
          echo "$DIFF_OUTPUT"
          
          if echo "$DIFF_OUTPUT" | grep -q "Diff\|Rows\|Changes"; then
            echo "✅ Changes detected, committing..."
            dolt add -A
            dolt commit -m "Daily ETL update $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo "✅ Committed successfully"
            echo ""
            echo "Pushing to DoltHub..."
            echo "   Checking remote configuration..."
            dolt remote -v
            echo ""
            echo "   Attempting push..."
            PUSH_OUTPUT=$(dolt push origin main 2>&1)
            PUSH_EXIT=$?
            
            if [ $PUSH_EXIT -eq 0 ]; then
              echo "✅ Successfully pushed to DoltHub"
            else
              echo "$PUSH_OUTPUT"
              echo ""
              # Check if error is "already up to date" (this is OK)
              if echo "$PUSH_OUTPUT" | grep -qi "up to date\|already.*up.*to.*date\|nothing to push"; then
                echo "ℹ️  Remote is already up to date (this is OK)"
              # Check if error is authentication-related (this is a problem)
              elif echo "$PUSH_OUTPUT" | grep -qi "authentication\|unauthorized\|credential\|permission denied"; then
                echo "❌ Authentication error - credentials may not be configured correctly"
                echo ""
                echo "   Debugging info:"
                echo "   Available credentials:"
                dolt creds ls 2>&1 || echo "   (Could not list credentials)"
                echo ""
                echo "   Credential files:"
                ls -la ~/.dolt/creds/ 2>&1 || echo "   (Could not list credential files)"
                exit 1
              else
                echo "⚠️  Push failed (exit code: $PUSH_EXIT)"
                echo "   This may be a temporary network issue"
                echo "   The commit was successful, so data is safe locally"
                # Don't fail the workflow for network issues
              fi
            fi
          else
            echo "ℹ️  No changes detected (data may already be up to date)"
          fi

          # Stop server
          if [ -f /tmp/dolt_server.pid ]; then
            kill "$(cat /tmp/dolt_server.pid)" || true
            rm -f /tmp/dolt_server.pid
          else
            pkill -f "dolt sql-server" || true
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Daily ETL update failed"
          echo "Check logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          