name: Daily ETL Update

on:
  schedule:
    # Run daily at 2 AM UTC (11 PM Argentina time previous day)
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to update (default: 7)'
        required: false
        default: '7'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Dolt
        run: |
          sudo bash -c 'curl -L https://github.com/dolthub/dolt/releases/latest/download/install.sh | bash'
          sudo cp /usr/local/bin/dolt /usr/bin/dolt
      
      - name: Configure Dolt
        env:
          DOLT_CREDS_PRIVATE_KEY: ${{ secrets.DOLT_CREDS_PRIVATE_KEY }}
        run: |
          # Configure Dolt user
          dolt config --global --add user.name "GitHub Actions"
          dolt config --global --add user.email "actions@github.com"
          
          # Set up Dolt credentials directory
          mkdir -p ~/.dolt/creds
          
          # Get credential ID from private key filename pattern
          # The private key should be a JWK file
          CRED_ID=$(echo "$DOLT_CREDS_PRIVATE_KEY" | head -c 52 | tail -c 52)
          
          # Save the private key
          echo "$DOLT_CREDS_PRIVATE_KEY" > ~/.dolt/creds/${CRED_ID}.jwk
          chmod 600 ~/.dolt/creds/${CRED_ID}.jwk
          
          echo "✅ Credentials configured"
      
      - name: Clone or update Dolt database
        run: |
          # Clone the database if it doesn't exist (using SSH)
          if [ ! -d "dolt_db" ]; then
            dolt clone rbasa/macroeconomia dolt_db
          else
            cd dolt_db
            dolt pull
            cd ..
          fi
      
      - name: Start Dolt SQL Server
        run: |
          cd dolt_db
          
          # Start server in background
          nohup dolt sql-server > server.log 2>&1 &
          SERVER_PID=$!
          
          # Wait for server to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if dolt sql -q "SELECT 1" 2>/dev/null; then
              echo "✅ Server ready!"
              break
            fi
            echo "  Waiting... ($i/30)"
            sleep 1
          done
          
          # Create user with permissions
          echo "Creating database user..."
          dolt sql -q "CREATE USER IF NOT EXISTS 'user'@'localhost' IDENTIFIED BY ''"
          dolt sql -q "GRANT ALL PRIVILEGES ON *.* TO 'user'@'localhost'"
          dolt sql -q "FLUSH PRIVILEGES"
          
          echo "✅ SQL Server running (PID: $SERVER_PID)"
      
      - name: Run ETL Update
        env:
          DOLT_DB: "mysql://user:@localhost:3306/macroeconomia"
          UPDATE_DAYS: ${{ github.event.inputs.days_back || '7' }}
        run: |
          python etl/daily_update.py
      
      - name: Commit changes to Dolt
        run: |
          cd dolt_db
          
          # Check if there are changes
          if ! dolt diff --stat | grep -q "Diff"; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Add and commit changes
          dolt add fx_rate
          dolt commit -m "Daily ETL update $(date '+%Y-%m-%d %H:%M UTC')"
      
      - name: Push to DoltHub
        run: |
          cd dolt_db
          
          # Check if there are commits to push
          if git rev-list @{u}.. 2>/dev/null | grep -q .; then
            dolt push origin main
            echo "✅ Pushed to DoltHub"
          else
            echo "⏸️  Nothing to push"
          fi
      
      - name: Stop Dolt SQL Server
        if: always()
        run: |
          pkill -f "dolt sql-server" || true
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Daily ETL update failed"
          echo "Check logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

